sudo: false
dist: trusty

language: node_js
node_js:
  - 'node'

cache:
  yarn: true
  directories:
    - node_modules
    - ~/.cache

before_install:
  - npm i -g yarn codecov

install:
  - yarn install --frozen-lockfile
  - yarn cypress install

before_script:
  - git fetch --unshallow

script:
  - yarn build
  - yarn build-zip
  - yarn test:e2e:ci
  - test -f dist/manifest.json
  - test -f dist/background.js
  - test -f dist/vendor.js
  - test -f dist/vendor.css
  - test -f dist/popup/popup.js
  - test -f dist/popup/popup.css
  - test -f dist/options/options.js
  - test -f dist/options/options.css
  - test -f "dist-zip/Solary-v$(node -pe "require('./package.json').version").zip"

before_deploy:
  - export RELEASE_EXTENSION_FILE=$(ls dist-zip/*.zip)
  - echo "Deploying ${RELEASE_EXTENSION_FILE} to GitHub releases"

deploy:
  provider: releases
  api_key:
    secure: hsWmvd/SiCPrVUepxy5w98VUKoJFN4Szvbvm1n8iyZMyM6YQa3iocKRIWQDQn3pIfScMoP70RjJ9pz83ERl7TmQlO4oqa3gNzz4QI6jy2n4683KfMdznOUnEgnQhzKdgZgO50yLHfpZb9n3LwlfC3RTVTPvWCYkb8c5eO/0dul68NHRP1K37DUNBJARUQpgwXpD7MVbCwdb9cEf4DB1MDA1EUX5OLDdwI2T4W31ox14wdn971HaQr2KPNkIxWWaIoNJV/pyNdF51I6C0+CjMgMHlkTEdtRqyz6kGKjHXUJVtNy5LHTQLjl7SzhJBFSu3IQHkh4cEPKlLgCQS0ZID2snXM+n5bxYmEBPHOLnTRgme/sDxQ5yXgcUPIqWabbW2T5byFx4rFuZCeKZNriGqwJ0ut/OvQiQTPYd4cFTxnHW5DtSs+zbCk+MZmuXHbLCmUqF+zuR7H3/YGbQDUpKjYTRqY2xN1nPMufuQJ2kDRG2r6dZxkwmGCsT0sEyVS8I6urArGtOZSqIhM8trsXefOjb2Iv3IzouAWAnK1hn7NXYSIM4qQbg2E9VBcDfv7DkH2qiuiCwrxYpm1lMS/7Ip4NCXfbEU7ECKPnU/dF1h6+zkKtgoU1+HvKFpndqLisb5WqE46uU940wl/6BGmk6A6HE96B1r9NDDwoMJef5tZXA=
  file: '${RELEASE_EXTENSION_FILE}'
  skip_cleanup: true
  on:
    repo: Kocal-Web-Extensions/Solary
    tags: true
